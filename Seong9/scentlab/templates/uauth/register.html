{% extends "scentpick/base.html" %}
{% block title %}회원가입 - ScentPick{% endblock %}
{% block content %}
<div class="auth-container">
  <h2 style="text-align:center;margin-bottom:30px;color:#2d3748;">회원가입</h2>

  {% if errors %}
    <div style="background-color: #fed7d7; border: 1px solid #e53e3e; color: #c53030; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
      <ul style="margin: 0; padding-left: 20px;">
        {% for error in errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}

    <div class="form-group">
      <label>아이디</label>
      <input type="text" name="username" id="username-input" value="{{ form_data.username|default:'' }}" placeholder="아이디를 입력하세요" required>
      <div id="username-feedback" style="margin-top: 5px; font-size: 14px; min-height: 20px;"></div>
    </div>

    <div class="form-group">
      <label>비밀번호</label>
      <input type="password" name="password1" placeholder="비밀번호를 입력하세요 (8자 이상)" required>
    </div>

    <div class="form-group">
      <label>비밀번호 확인</label>
      <input type="password" name="password2" placeholder="비밀번호를 다시 입력하세요" required>
    </div>

    <div class="form-group">
      <label>이름</label>
      <input type="text" name="name" value="{{ form_data.name|default:'' }}" placeholder="이름을 입력하세요" required>
    </div>

    <div class="form-group">
      <label>이메일</label>
      <input type="email" name="email" value="{{ form_data.email|default:'' }}" placeholder="이메일을 입력하세요" required>
    </div>

    <div class="form-group">
      <label>출생연도</label>
      <input type="number" name="birth_year" value="{{ form_data.birth_year|default:'' }}" min="1900" max="2100" placeholder="예: 1995" required>
    </div>

    <div class="form-group">
      <label>성별</label>
      <div class="gender-selection">
        <button type="button" class="gender-btn {% if form_data.gender == 'Male' %}selected{% endif %}" data-gender="Male">남성</button>
        <button type="button" class="gender-btn {% if form_data.gender == 'Female' %}selected{% endif %}" data-gender="Female">여성</button>
      </div>
      <input type="hidden" name="gender" id="gender-input" value="{{ form_data.gender|default:'' }}" required>
    </div>

    <button type="submit" class="btn-primary">회원가입</button>

    <div style="text-align:center;margin-top:20px;">
      <a href="{% url 'uauth:login' %}" style="color:#718096;text-decoration:none;font-size:14px;">이미 계정이 있으신가요? 로그인</a>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const genderButtons = document.querySelectorAll(".gender-btn");
  const genderInput = document.getElementById("gender-input");
  const usernameInput = document.getElementById("username-input");
  const usernameFeedback = document.getElementById("username-feedback");
  
  let debounceTimer;

  // 성별 선택 기능
  genderButtons.forEach((btn) => {
    btn.addEventListener("click", function () {
      genderButtons.forEach((b) => b.classList.remove("selected"));
      this.classList.add("selected");
      genderInput.value = this.dataset.gender;
    });
  });

  // 아이디 중복 확인
  async function checkUsername(username) {
    if (username.length < 3) {
      usernameFeedback.innerHTML = '<span style="color: #6b7280;">아이디는 3자 이상 입력하세요.</span>';
      return;
    }

    usernameFeedback.innerHTML = '<span style="color: #6b7280;">확인 중...</span>';

    try {
      const response = await fetch('/uauth/check-username/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({username: username})
      });

      const data = await response.json();
      
      if (data.available) {
        usernameFeedback.innerHTML = '<span style="color: #10b981;">✓ 사용 가능한 아이디입니다.</span>';
      } else {
        usernameFeedback.innerHTML = '<span style="color: #ef4444;">✗ 이미 사용 중인 아이디입니다.</span>';
      }
    } catch (error) {
      usernameFeedback.innerHTML = '<span style="color: #ef4444;">확인 중 오류가 발생했습니다.</span>';
    }
  }

  // 아이디 입력 이벤트
  usernameInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    const username = this.value.trim();
    
    if (username === '') {
      usernameFeedback.innerHTML = '';
      return;
    }

    debounceTimer = setTimeout(() => {
      checkUsername(username);
    }, 500);
  });
});
</script>
{% endblock %}